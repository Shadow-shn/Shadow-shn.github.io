<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Realtime Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family: system-ui, -apple-system;
  background:#0f172a;
  color:white;
}
.chat-box{
  max-width:500px;
  margin:auto;
  height:100vh;
  display:flex;
  flex-direction:column;
}
.header{
  padding:12px;
  background:#020617;
  text-align:center;
  font-weight:600;
}
.status{
  font-size:.8rem;
  opacity:.7;
}
.messages{
  flex:1;
  padding:15px;
  overflow-y:auto;
  background:#020617;
}
.msg{
  max-width:75%;
  padding:10px 14px;
  margin-bottom:10px;
  border-radius:14px;
  font-size:.95rem;
}
.me{
  background:#2563eb;
  margin-left:auto;
  border-bottom-right-radius:4px;
}
.other{
  background:#1e293b;
  margin-right:auto;
  border-bottom-left-radius:4px;
}
.name{
  font-size:.75rem;
  opacity:.7;
  margin-bottom:4px;
}
.typing{
  font-size:.8rem;
  opacity:.7;
  margin:5px 0;
}
.input-area{
  padding:10px;
  background:#020617;
}
input{
  width:100%;
  padding:12px;
  border:none;
  border-radius:10px;
  margin-bottom:8px;
}
button{
  width:100%;
  padding:12px;
  border:none;
  border-radius:10px;
  background:#2563eb;
  color:white;
  font-weight:600;
}
.login{
  padding:20px;
  text-align:center;
}
.profile{
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px;
  background:#020617;
}
.profile img{
  width:36px;
  height:36px;
  border-radius:50%;
}
</style>
</head>

<body>

<div class="chat-box">
  <div class="header">
    üí¨ Public Chat
    <div class="status" id="onlineStatus">üü¢ 0 online</div>
  </div>

  <div class="login" id="loginBox">
    <button onclick="login()">üîê Sign in with Google</button>
  </div>

  <div class="profile" id="profileBox" style="display:none">
    <img id="avatar">
    <div id="username"></div>
    <button onclick="logout()">Logout</button>
  </div>

  <div class="messages" id="messages"></div>
  <div class="typing" id="typing"></div>

  <div class="input-area">
    <input id="msg" placeholder="Type message">
    <button onclick="send()">Send</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, setDoc, doc, deleteDoc }
from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut }
from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

/* üî• FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyD6wuDYeftzktN3JiO6HqdxDR316thEzTY",
  authDomain: "shadow-chat-15c3b.firebaseapp.com",
  projectId: "shadow-chat-15c3b",
  storageBucket: "shadow-chat-15c3b.firebasestorage.app",
  messagingSenderId: "284971750396",
  appId: "1:284971750396:web:05bdc595fcdeb933441879"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

const msgCol = collection(db,"messages");
const onlineCol = collection(db,"online");
const typingCol = collection(db,"typing");

let user=null;
const onlineId=Math.random().toString(36).slice(2);

/* AUTH */
window.login = async()=>{
  await signInWithPopup(auth, provider);
};
window.logout = async()=>{
  await signOut(auth);
};

onAuthStateChanged(auth,u=>{
  user=u;
  document.getElementById("loginBox").style.display = u?"none":"block";
  document.getElementById("profileBox").style.display = u?"flex":"none";
  if(u){
    document.getElementById("username").innerText=u.displayName;
    document.getElementById("avatar").src=u.photoURL;
  }
});

/* ONLINE */
setInterval(async()=>{
  if(user){
    await setDoc(doc(onlineCol, onlineId),{
      name:user.displayName,
      time:Date.now()
    });
  }
},5000);

window.addEventListener("beforeunload",()=>{
  deleteDoc(doc(onlineCol, onlineId));
});

onSnapshot(onlineCol,snap=>{
  document.getElementById("onlineStatus").innerText =
    "üü¢ " + snap.size + " online";
});

/* MESSAGES */
const q=query(msgCol,orderBy("time"));
onSnapshot(q,snap=>{
  const box=document.getElementById("messages");
  box.innerHTML="";
  snap.forEach(d=>{
    const m=d.data();
    const div=document.createElement("div");
    div.className="msg " + (user && m.name===user.displayName ? "me":"other");
    const t=new Date(m.time).toLocaleTimeString([],{
      hour:"2-digit",minute:"2-digit"
    });
    div.innerHTML=`<div class="name">${m.name} ‚Ä¢ ${t}</div>${m.text}`;
    box.appendChild(div);
  });
  box.scrollTop=box.scrollHeight;
});

/* TYPING */
let tmo;
document.getElementById("msg").addEventListener("input",async()=>{
  if(!user) return;
  await setDoc(doc(typingCol,user.displayName),{typing:true});
  clearTimeout(tmo);
  tmo=setTimeout(()=>deleteDoc(doc(typingCol,user.displayName)),1500);
});

onSnapshot(typingCol,snap=>{
  const arr=[];
  snap.forEach(d=>{
    if(!user || d.id!==user.displayName) arr.push(d.id);
  });
  document.getElementById("typing").innerText =
    arr.length ? arr.join(", ")+" is typing..." : "";
});

/* SEND */
window.send = async()=>{
  if(!user){
    alert("Login required");
    return;
  }
  const text=document.getElementById("msg").value;
  if(!text) return;
  await addDoc(msgCol,{
    name:user.displayName,
    photo:user.photoURL,
    text,
    time:Date.now()
  });
  document.getElementById("msg").value="";
};

document.getElementById("msg").addEventListener("keypress",e=>{
  if(e.key==="Enter") send();
});
</script>

</body>
</html>
