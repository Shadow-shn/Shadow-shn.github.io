<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Realtime Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family: system-ui, -apple-system;
  background:#0f172a;
  color:white;
}
.chat-box{
  max-width:500px;
  margin:auto;
  height:100vh;
  display:flex;
  flex-direction:column;
}
.header{
  padding:12px;
  background:#020617;
  text-align:center;
  font-weight:600;
}
.status{
  font-size:.8rem;
  opacity:.7;
}
.name-area{
  padding:10px;
  background:#020617;
}
.messages{
  flex:1;
  padding:15px;
  overflow-y:auto;
  background:#020617;
}
.msg{
  max-width:75%;
  padding:10px 14px;
  margin-bottom:10px;
  border-radius:14px;
  font-size:.95rem;
}
.me{
  background:#2563eb;
  margin-left:auto;
  border-bottom-right-radius:4px;
}
.other{
  background:#1e293b;
  margin-right:auto;
  border-bottom-left-radius:4px;
}
.name{
  font-size:.75rem;
  opacity:.7;
  margin-bottom:4px;
}
.typing{
  font-size:.8rem;
  opacity:.7;
  margin:5px 0;
}
.input-area{
  padding:10px;
  background:#020617;
}
input{
  width:100%;
  padding:12px;
  border:none;
  border-radius:10px;
  margin-bottom:8px;
}
button{
  width:100%;
  padding:12px;
  border:none;
  border-radius:10px;
  background:#2563eb;
  color:white;
  font-weight:600;
}
</style>
</head>

<body>

<div class="chat-box">
  <div class="header">
    ðŸ’¬ Public Chat
    <div class="status" id="onlineStatus">ðŸŸ¢ 0 online</div>
  </div>

  <div class="name-area">
    <input id="name" placeholder="Enter your name (required)">
  </div>

  <div class="messages" id="messages"></div>
  <div class="typing" id="typing"></div>

  <div class="input-area">
    <input id="msg" placeholder="Type message">
    <button onclick="send()">Send</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, setDoc, doc, deleteDoc }
from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

/* ðŸ”¥ FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyD6wuDYeftzktN3JiO6HqdxDR316thEzTY",
  authDomain: "shadow-chat-15c3b.firebaseapp.com",
  projectId: "shadow-chat-15c3b",
  storageBucket: "shadow-chat-15c3b.firebasestorage.app",
  messagingSenderId: "284971750396",
  appId: "1:284971750396:web:05bdc595fcdeb933441879"
};

/* INIT */
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* COLLECTIONS */
const msgCol = collection(db,"messages");
const onlineCol = collection(db,"online");
const typingCol = collection(db,"typing");

/* NAME SAVE */
const nameInput = document.getElementById("name");
nameInput.value = localStorage.getItem("chatName") || "";
nameInput.oninput = () => localStorage.setItem("chatName", nameInput.value);

/* ONLINE STATUS */
const onlineId = Math.random().toString(36).slice(2);

setInterval(async ()=>{
  const name = localStorage.getItem("chatName");
  if(name){
    await setDoc(doc(onlineCol, onlineId),{
      name,
      time: Date.now()
    });
  }
}, 5000);

window.addEventListener("beforeunload",()=>{
  deleteDoc(doc(onlineCol, onlineId));
});

onSnapshot(onlineCol, snap=>{
  document.getElementById("onlineStatus").innerText =
    "ðŸŸ¢ " + snap.size + " online";
});

/* MESSAGES */
const q = query(msgCol, orderBy("time"));
onSnapshot(q, snap=>{
  const box=document.getElementById("messages");
  box.innerHTML="";
  const myName = localStorage.getItem("chatName");

  snap.forEach(docu=>{
    const d=docu.data();
    const div=document.createElement("div");
    div.className="msg " + (d.name===myName ? "me":"other");

    const time=new Date(d.time).toLocaleTimeString([],{
      hour:"2-digit", minute:"2-digit"
    });

    div.innerHTML=`<div class="name">${d.name} â€¢ ${time}</div>${d.text}`;
    box.appendChild(div);
  });

  box.scrollTop=box.scrollHeight;
});

/* TYPING INDICATOR */
let typingTimeout;
document.getElementById("msg").addEventListener("input",async ()=>{
  const name=localStorage.getItem("chatName");
  if(!name) return;

  await setDoc(doc(typingCol,name),{typing:true});

  clearTimeout(typingTimeout);
  typingTimeout=setTimeout(()=>{
    deleteDoc(doc(typingCol,name));
  },1500);
});

onSnapshot(typingCol,snap=>{
  const box=document.getElementById("typing");
  const myName=localStorage.getItem("chatName");
  const arr=[];
  snap.forEach(d=>{
    if(d.id!==myName) arr.push(d.id);
  });
  box.innerText = arr.length ? `${arr.join(", ")} is typing...` : "";
});

/* SEND MESSAGE */
window.send = async ()=>{
  const name=localStorage.getItem("chatName");
  const text=document.getElementById("msg").value;

  if(!name || name.trim()===""){
    alert("Please enter your name first");
    return;
  }
  if(!text) return;

  await addDoc(msgCol,{
    name,
    text,
    time: Date.now()
  });

  document.getElementById("msg").value="";
};

/* ENTER TO SEND */
document.getElementById("msg").addEventListener("keypress",e=>{
  if(e.key==="Enter") send();
});
</script>

</body>
</html>
